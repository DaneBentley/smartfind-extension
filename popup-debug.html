<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <style>
        body { width: 400px; padding: 16px; font-family: monospace; font-size: 12px; }
        .log { background: #f5f5f5; padding: 8px; margin: 4px 0; border-radius: 4px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { margin: 4px; padding: 8px 12px; }
    </style>
</head>
<body>
    <h3>SmartFind Auth Debug</h3>
    
    <button onclick="testGoogleAuth()">Test Google Auth</button>
    <button onclick="testBackendAPI()">Test Backend API</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        async function testGoogleAuth() {
            log('üîë Testing Google OAuth...', 'info');
            
            try {
                chrome.identity.getAuthToken({ interactive: true }, async (token) => {
                    if (chrome.runtime.lastError) {
                        log('‚ùå Google OAuth Error: ' + chrome.runtime.lastError.message, 'error');
                        return;
                    }
                    
                    log('‚úÖ Got Google token: ' + (token ? 'Yes' : 'No'), 'success');
                    
                    if (token) {
                        // Test Google user info
                        try {
                            const response = await fetch(`https://www.googleapis.com/oauth2/v1/userinfo?access_token=${token}`);
                            log('üìä Google API Status: ' + response.status, 'info');
                            
                            if (response.ok) {
                                const userInfo = await response.json();
                                log('‚úÖ User Info: ' + userInfo.email, 'success');
                                
                                // Now test backend
                                await testBackendOAuth(token, userInfo);
                            } else {
                                const errorText = await response.text();
                                log('‚ùå Google API Error: ' + errorText, 'error');
                            }
                        } catch (error) {
                            log('‚ùå Google API Exception: ' + error.message, 'error');
                        }
                    }
                });
            } catch (error) {
                log('‚ùå OAuth Exception: ' + error.message, 'error');
            }
        }
        
        async function testBackendOAuth(token, userInfo) {
            log('üîó Testing Backend OAuth...', 'info');
            
            const API_BASE_URL = 'https://smartfind-extension-brmw2k4cv.vercel.app';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/oauth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'google',
                        googleToken: token,
                        email: userInfo.email,
                        name: userInfo.name,
                        picture: userInfo.picture
                    })
                });
                
                log('üìä Backend Status: ' + response.status, 'info');
                
                const responseText = await response.text();
                log('üìÑ Response Length: ' + responseText.length + ' chars', 'info');
                log('üìÑ Response Start: ' + responseText.substring(0, 100), 'info');
                
                if (response.ok) {
                    try {
                        const result = JSON.parse(responseText);
                        log('‚úÖ Backend Success: ' + result.message, 'success');
                    } catch (jsonError) {
                        log('‚ùå JSON Parse Error: ' + jsonError.message, 'error');
                        log('üîç Full Response: ' + responseText, 'error');
                    }
                } else {
                    log('‚ùå Backend Error: ' + responseText, 'error');
                }
                
            } catch (error) {
                log('‚ùå Backend Exception: ' + error.message, 'error');
            }
        }
        
        async function testBackendAPI() {
            log('üîó Testing Backend API...', 'info');
            
            const API_BASE_URL = 'https://smartfind-extension-brmw2k4cv.vercel.app';
            
            // Test basic API
            try {
                const response = await fetch(`${API_BASE_URL}/api/test`);
                log('üìä API Test Status: ' + response.status, 'info');
                const text = await response.text();
                log('üìÑ API Test Response: ' + text.substring(0, 100), 'info');
            } catch (error) {
                log('‚ùå API Test Error: ' + error.message, 'error');
            }
            
            // Test OAuth endpoint with dummy data
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/oauth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'google',
                        googleToken: 'dummy-token',
                        email: 'test@example.com',
                        name: 'Test User'
                    })
                });
                
                log('üìä OAuth Test Status: ' + response.status, 'info');
                const text = await response.text();
                log('üìÑ OAuth Test Response: ' + text.substring(0, 200), 'info');
                
                try {
                    JSON.parse(text);
                    log('‚úÖ OAuth returns valid JSON', 'success');
                } catch (jsonError) {
                    log('‚ùå OAuth returns invalid JSON: ' + jsonError.message, 'error');
                }
                
            } catch (error) {
                log('‚ùå OAuth Test Error: ' + error.message, 'error');
            }
        }
        
        // Auto-run basic test
        log('üöÄ SmartFind Auth Debug Ready', 'info');
        testBackendAPI();
    </script>
</body>
</html> 